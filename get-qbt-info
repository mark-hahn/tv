#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CREDS_FILE="$ROOT_DIR/torrents/cookies/qbt-cred.txt"
OUT_FILE="$ROOT_DIR/misc/qb-info.json"

if ! command -v curl >/dev/null 2>&1; then
  echo "curl not found in WSL. Install it (e.g. sudo apt-get install -y curl)." 1>&2
  exit 1
fi

if [ ! -f "$CREDS_FILE" ]; then
  echo "Missing creds file: $CREDS_FILE" 1>&2
  exit 1
fi

trim() {
  local s="$1"
  s="${s#${s%%[![:space:]]*}}" # ltrim
  s="${s%${s##*[![:space:]]}}" # rtrim
  printf '%s' "$s"
}

strip_optional_quotes() {
  local s
  s="$(trim "$1")"
  if [ "${#s}" -ge 2 ]; then
    local first="${s:0:1}"
    local last="${s: -1}"
    if { [ "$first" = '"' ] && [ "$last" = '"' ]; } || { [ "$first" = "'" ] && [ "$last" = "'" ]; }; then
      s="${s:1:${#s}-2}"
    fi
  fi
  printf '%s' "$s"
}

QB_HOST=""
QB_PORT=""
QB_USER=""
QB_PASS=""

while IFS= read -r raw || [ -n "$raw" ]; do
  line="$(trim "$raw")"
  [ -z "$line" ] && continue
  case "$line" in
    \#*) continue ;;
  esac
  [[ "$line" != *"="* ]] && continue

  key="$(trim "${line%%=*}")"
  val="$(strip_optional_quotes "${line#*=}")"

  case "$key" in
    QB_HOST) QB_HOST="$val" ;;
    QB_PORT) QB_PORT="$val" ;;
    QB_USER) QB_USER="$val" ;;
    QB_PASS) QB_PASS="$val" ;;
  esac
done < "$CREDS_FILE"

# Allow QB_USER to be omitted when QB_HOST is in user@host form.
if [ -z "$QB_USER" ] && [[ "$QB_HOST" == *"@"* ]]; then
  QB_USER="${QB_HOST%%@*}"
fi

if [ -z "$QB_HOST" ] || [ -z "$QB_PORT" ] || [ -z "$QB_USER" ] || [ -z "$QB_PASS" ]; then
  echo "Missing required keys in $CREDS_FILE. Need QB_HOST, QB_PORT, QB_PASS, and QB_USER (or set QB_HOST as user@host so QB_USER can be derived)." 1>&2
  exit 1
fi

if ! [[ "$QB_PORT" =~ ^[0-9]+$ ]]; then
  echo "Invalid QB_PORT: $QB_PORT" 1>&2
  exit 1
fi

# If QB_HOST is like user@host, use the host portion for HTTP.
HTTP_HOST="$QB_HOST"
if [[ "$HTTP_HOST" == *"@"* ]]; then
  HTTP_HOST="${HTTP_HOST##*@}"
fi

BASE="http://${HTTP_HOST}:${QB_PORT}"
COOKIE_JAR="$(mktemp)"
trap 'rm -f "$COOKIE_JAR"' EXIT

# qBittorrent expects Origin/Referer in some configs.
ORIGIN="$BASE"
REFERER="$BASE/"

LOGIN_RESP="$(
  curl -sS \
    -c "$COOKIE_JAR" \
    -H "Origin: $ORIGIN" \
    -H "Referer: $REFERER" \
    -d "username=${QB_USER}&password=${QB_PASS}" \
    "$BASE/api/v2/auth/login" \
    || true
)"

if [ "$LOGIN_RESP" != "Ok." ] && [ "$LOGIN_RESP" != "Ok" ]; then
  echo "qBittorrent login failed: $LOGIN_RESP" 1>&2
  exit 1
fi

mkdir -p "$(dirname "$OUT_FILE")"

curl -sS \
  -b "$COOKIE_JAR" \
  -H "Origin: $ORIGIN" \
  -H "Referer: $REFERER" \
  -H "Accept: application/json" \
  "$BASE/api/v2/torrents/info" \
  > "$OUT_FILE"

echo "Wrote qBittorrent torrents info to: $OUT_FILE"
