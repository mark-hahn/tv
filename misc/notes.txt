
OpenSubtitles API (v1) — quick reference
======================================

This project’s “Subs” pane will use the OpenSubtitles HTTP API.

Base URL
--------

- Base: https://api.opensubtitles.com/api/v1

Access model (how you call it)
------------------------------

OpenSubtitles v1 is a JSON REST API.

You typically use *two* kinds of access:

1) App access (API key)
	 - You register an application on OpenSubtitles and get an API key.
	 - You pass it on requests as a header (commonly):
		 - Api-Key: <YOUR_API_KEY>

2) User access (Bearer token) (optional)
	 - For user-specific features/quotas, you authenticate a user (login) and receive a token.
	 - You pass it as a header:
		 - Authorization: Bearer <TOKEN>

Notes:
- Some endpoints may work with just an Api-Key; others may require a Bearer token.
- If you get 401/403/503, it’s often “missing key/token” or temporary service/rate limiting.

Common headers
--------------

- Content-Type: application/json (for POST/PUT bodies)
- Accept: application/json
- Api-Key: <YOUR_API_KEY>
- Authorization: Bearer <TOKEN> (only after login)
- (Recommended) User-Agent: <your-app-name> (some deployments may require/expect it)

Endpoints (most-used)
---------------------

1) Languages
	 - GET /infos/languages
	 - Returns a list of language codes/names.
	 - Verified reachable:
		 - https://api.opensubtitles.com/api/v1/infos/languages

2) Login (get token)
	 - POST /login
	 - Body (typical): { "username": "...", "password": "..." }
	 - Response: token + user info (shape depends on API version).

3) Search subtitles
	 - GET /subtitles
	 - Returns: a list of subtitle entries (often under a `data` array), usually with file entries.
	 - Typical query params you’ll see used (verify exact names in the official docs):
		 - query: free text search
		 - languages: language code(s) (ex: "en" or "en,es")
		 - imdb_id: numeric IMDb id (tt1234567 without “tt”, depending on API)
		 - tmdb_id: TMDB id
		 - season_number, episode_number (TV)
		 - year
		 - page (pagination)

	 Practical approach for TV episodes:
	 - If you have IMDb/TMDB + season/episode: prefer ID-based search.
	 - Otherwise: use query + season/episode hints.

4) Download
	 - POST /download
	 - You select a specific subtitle file by `file_id` (returned by search).
	 - Body (typical): { "file_id": 123456 }
	 - Response: usually includes a temporary `link` URL to fetch the subtitle file.
	 - The returned link is what you actually HTTP GET to retrieve the file contents.

5) Current user info (requires token)
	 - GET /infos/user
	 - Used to check quota / remaining downloads / user rank (depends on API).

6) Logout (requires token)
	 - Often present as DELETE /logout or POST /logout (verify in official docs)



Command examples (PowerShell-friendly curl)
------------------------------------------

Important (PowerShell):
- In Windows PowerShell, `curl` is commonly an alias for `Invoke-WebRequest`.
- If you want “real curl”, call `curl.exe` explicitly.
- PowerShell line continuation is the backtick: ` (not `^`).

1) List languages (no auth required in practice; API key may still be expected)

curl.exe -s "https://api.opensubtitles.com/api/v1/infos/languages" `
	-H "Accept: application/json"

2) Login (get Bearer token)

Credentials live in torrents/cookies/subs-login.txt (local-only; gitignored):
- { "apiKey": "...", "username": "...", "password": "..." }

$creds = Get-Content -Raw "torrents/cookies/subs-login.txt" | ConvertFrom-Json

Option A: curl.exe (recommended if installed)

curl.exe -s "https://api.opensubtitles.com/api/v1/login" `
	-H "Content-Type: application/json" `
	-H "Accept: application/json" `
	-H "Api-Key: $($creds.apiKey)" `
	-d "{\"username\":\"$($creds.username)\",\"password\":\"$($creds.password)\"}"

Option B: PowerShell-native Invoke-RestMethod

$headers = @{
	"Api-Key" = $creds.apiKey
	"Accept"  = "application/json"
}
$body = @{ username = $creds.username; password = $creds.password } | ConvertTo-Json
Invoke-RestMethod -Method Post -Uri "https://api.opensubtitles.com/api/v1/login" -Headers $headers -ContentType "application/json" -Body $body

3) Search subtitles (example: query + language)

curl.exe -s "https://api.opensubtitles.com/api/v1/subtitles?query=breaking%20bad&languages=en" `
	-H "Accept: application/json" `
	-H "Api-Key: $($creds.apiKey)"

4) Search subtitles (example: TV episode pattern — verify param names)

curl.exe -s "https://api.opensubtitles.com/api/v1/subtitles?tmdb_id=12345&season_number=1&episode_number=1&languages=en" `
	-H "Accept: application/json" `
	-H "Api-Key: $($creds.apiKey)" `
	-H "Authorization: Bearer YOUR_TOKEN"

5) Download (get a temporary link) (file_id comes from search results)

curl.exe -s "https://api.opensubtitles.com/api/v1/download" `
	-H "Content-Type: application/json" `
	-H "Accept: application/json" `
	-H "Api-Key: $($creds.apiKey)" `
	-H "Authorization: Bearer YOUR_TOKEN" `
	-d "{\"file_id\":123456789}"

Then fetch the returned link:

curl -L "THE_LINK_FROM_DOWNLOAD_RESPONSE" -o subtitle.zip

Implementation notes (for our client)
-------------------------------------

Node helper (uses fetch, not curl)
---------------------------------

Use the Node CLI in misc/subs-curl.js (reads torrents/cookies/subs-login.txt):

- node misc/subs-curl.js languages
- node misc/subs-curl.js login
- node misc/subs-curl.js search --query "breaking bad" --languages "en"
- node misc/subs-curl.js search --imdb-id tt0903747 --season 1 --episode 1 --languages "en"
- node misc/subs-curl.js download --file-id 123456789

- Store Api-Key (and optionally username/password) in config/secrets, not in repo.
- Token: treat as short-lived; cache in memory; refresh by re-login when needed.
- Search result parsing:
	- Look for a per-result list of files and pick the best `file_id`.
	- Prefer exact language match + hearing-impaired flag when relevant.
- Be defensive:
	- Handle 401/403 (missing/expired key/token), 429/503 (rate limit / service busy).

