# =========================================
# HTTPS — eridien.com
# =========================================
server {
  listen 443 ssl http2;
  server_name eridien.com www.eridien.com;

  root /root/www;

  # TLS (Let's Encrypt RSA)
  ssl_certificate     /etc/letsencrypt/live/eridien.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/eridien.com/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# =========================================
# HTTPS — hahnca.com
# =========================================
server {
  listen 443 ssl http2;
  server_name hahnca.com www.hahnca.com;

  # ---- Static roots ----
  location / {
    root /root/www;     # shared with eridien (intentional)
  }
  location /tv {
    root /mnt/media;    # (403 on /tv/ unless you enable autoindex)
  }
  location /shows {
    root /root/dev/apps/tv-series-client;
  }
  location /cam-sw {
    root /root/dev/apps/cam-sw;
  }

  # ---- Proxies ----
  # Home Assistant
  location ~* ^/(ha) {
    rewrite ^(.*)$ $1 break;
    proxy_pass http://127.0.0.1:8123;

    proxy_redirect      off;
    proxy_set_header    Host              $host;
    proxy_set_header    X-Real-IP         $remote_addr;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto $scheme;
    proxy_http_version  1.1;
    proxy_set_header    Upgrade           $http_upgrade;
    proxy_set_header    Connection        "upgrade";
    proxy_buffering     off;
    proxy_connect_timeout 43200000; # 12h
    proxy_read_timeout    43200000;
    proxy_send_timeout    43200000;
  }

  # /bath
  location /bath/ {
    proxy_pass http://127.0.0.1:1337;
  }

  # tv-series server
  location /tv-series-srvr {
    rewrite ^(.*)$ $1 break;
    proxy_pass http://localhost:8736;

    proxy_redirect      off;
    proxy_set_header    Host              $host;
    proxy_set_header    X-Real-IP         $remote_addr;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto $scheme;
    proxy_http_version  1.1;
    proxy_set_header    Upgrade           $http_upgrade;
    proxy_set_header    Connection        "upgrade";
    proxy_buffering     off;
    proxy_connect_timeout 43200000; # 12h
    proxy_read_timeout    43200000;
    proxy_send_timeout    43200000;
  }

  # group to 127.0.0.1:1339
  location ~* ^/(scroll|tvtab|mbtab|swbcb|hvac) {
    rewrite ^(.*)$ $1 break;
    proxy_pass http://127.0.0.1:1339;

    proxy_redirect      off;
    proxy_set_header    Host              $host;
    proxy_set_header    X-Real-IP         $remote_addr;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto $scheme;
    proxy_http_version  1.1;
    proxy_set_header    Upgrade           $http_upgrade;
    proxy_set_header    Connection        "upgrade";
    proxy_buffering     off;
    proxy_connect_timeout 43200000; # 12h
    proxy_read_timeout    43200000;
    proxy_send_timeout    43200000;
  }

  # TLS (Let's Encrypt RSA)
  ssl_certificate     /etc/letsencrypt/live/hahnca.com-rsa/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/hahnca.com-rsa/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# =========================================
# HTTP — redirect to HTTPS (with ACME path)
# =========================================
server {
  listen 80;
  server_name eridien.com www.eridien.com;

  # ACME challenge (safety belt)
  location ^~ /.well-known/acme-challenge/ {
    root /var/www/html;
    default_type "text/plain";
  }

  return 301 https://$host$request_uri;
}

server {
  listen 80;
  server_name hahnca.com www.hahnca.com;

  # ACME challenge
  location ^~ /.well-known/acme-challenge/ {
    root /var/www/html;
    default_type "text/plain";
  }

  return 301 https://$host$request_uri;
}

# --- emby cert stuff ---
#Auto-renew check (quarterly): sudo certbot renew --dry-run
#Emby PFX refresh (on demand): sudo /usr/local/sbin/emby-cert-refresh.sh
#Nginx safe-edit mantra: always sudo nginx -t && sudo systemctl reload nginx.
