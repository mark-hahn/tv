TV Series Client – Project Description (hand-off document)

Status / timeline
- The app was working as intended at commit: 1963a257f6dbf3210c6be85481d0fe1cd95d9c4b
- A later change set broke the intended TMDB actors behavior at commit: 9ae7d3e7d238d79175c416ee88d8c70cff634942
- The regression is centered in src/components/actors.vue (actors pane). The server process behavior was unchanged relative to the working commit.

High-level purpose
This project is a local “TV series operations dashboard” that:
- Reads your TV library data from Emby.
- Tracks “gaps” (missing episodes) and other show metadata.
- Searches/queues torrents for missing episodes and validates torrent contents.
- Ships downloaded content to removable media / target paths.
- Displays operational status across multiple panes (Series list, Details/Meta, Actors, Map, Torrents, Download Status, History, Flex, TVProc).

Core technology and structure
- Frontend: Vue 3 single-page app (Vite build), mostly SFCs under src/components.
	- Templates are written in Pug (<template lang="pug">).
	- Global event bus: src/evtBus.js (mitt-based) used for cross-pane coordination.
	- Client API modules:
		- src/emby.js: Emby API client (axios), show lists, episode maps, playback helper calls.
		- src/tvdb.js: TVDB helper client (series map / metadata).
		- src/srvr.js: websocket RPC client to an external server (wss://hahnca.com/tv-series-srvr) which provides TMDB lookups, “devices now playing”, and other server-side utilities.
		- src/urls.js: constructs Emby REST URLs (token-based and api_key-based patterns).

- Backend (local): Node/Express server under torrents/.
	- Started together with the client in “dev” mode.
	- Serves a small HTTP API at config.torrentsApiUrl (see src/config.js usage).
	- Key features:
		- /api/torrents endpoints (torrent search/download flow)
		- /api/tvproc endpoints (download/progress log cards)
		- USB/SFTP copy pipeline
	- Torrent parsing/validation uses:
		- parse-torrent (metainfo file list)
		- parse-torrent-title (extract season/episode from filenames)

App UI model (panes)
The SPA is built as multiple side panes/tabs, coordinated via evtBus “paneChanged” events.
Common patterns across panes:
- Empty-state UX: after the first request, show “Loading ...” only if the request is still in-flight after 2 seconds; after a completed request returns empty, show “No results.”
- Polling panes: some panes poll every N seconds (TVProc polls every 5s) and use a “stick-to-bottom only if already near bottom” scroll rule.

Key panes and behavior (as of the working commit)

1) Series pane (primary list)
- Shows list of shows, gap counts, sizes, and derived metadata.
- Selecting a show updates shared state (currentShow) and triggers other panes via evtBus.

2) Map pane
- Shows an episode “map” for a series (season/episode availability / watched / unaired).
- For no-Emby shows (“noemby-*”), it can still build a map using TVDB fallback.

3) Actors pane
The Actors pane has two modes:
- Regulars: show’s series regular cast.
- Guests: episode guest stars for a specific Season/Episode.

Working behavior at commit 1963a257f6dbf3210c6be85481d0fe1cd95d9c4b:
- Guests mode:
	- Calls srvr.getTmdb({showName, year:null, season:<N>, episode:<N>}).
	- Displays returned TMDB actors as cards; images use https://image.tmdb.org/t/p/w185 + profile_path.
	- Sorts with “has image first”, then by TMDB order.
- Regulars mode:
	- Uses TVDB “characters” list passed into the pane (from currentTvdbData) and renders it.
	- Does NOT depend on TMDB for Regulars.
- Arrow navigation:
	- Uses seriesMap to step through episodes; when you click arrows it loads Guests for the new episode.
	- For noemby shows, it uses TVDB fallback and prefetch/caching to avoid arrow stalls.

Regression at commit 9ae7d3e7d238d79175c416ee88d8c70cff634942:
- actors.vue was modified to try loading a “TMDB list” on Regulars load and merging TMDB+TVDB.
- This introduced a new TMDB request pattern for Regulars (series-level cast), which resulted in “tmdb list empty” even though Guests episode TMDB calls still returned actors.

4) Torrents pane
- Searches torrents for missing episodes.
- UX changes previously implemented:
	- Details button between download and search.
	- Click behavior: don’t auto-open details tab if the card already has a checkmark.
	- Header buttons sized like other tab buttons.
	- Initial scroll starts at bottom.
- Download validation:
	- When a .torrent is downloaded, parse its file list with parse-torrent.
	- Parse each filename with parse-torrent-title.
	- If any file lacks season or episode numbers, show modal: “Torrent file name is missing a season or episode number.” and abort sending to USB.
	- Log the parse results for testing.

5) Download Status (dlstatus) pane
- Shows current downloads.
- “downloading” state is displayed as “Getting”.
- Finished cards show:
	- Finished timestamp formatted as M/D HH:MM
	- Elapsed formatted as M:SS

6) History pane
- Similar empty-state improvements and “Getting” wording.

7) Flex pane
- Converts UTC timestamps to local display times.

8) TVProc pane
- Reads from torrents backend endpoint /api/tvproc which serves tv.json (JSON array of file objects).
- Displays one card per file object, updated by polling every 5 seconds.
- Card lines:
	- First line: sequence in blue, formatted as “<seq>) <title>” with reduced title font size (14px).
	- Second line: “S<season>:E<episode>” (blue), file size in “0.123 GB”, dateStarted “M/D HH:MM”, plus:
		- If status is downloading: “Downloading”
		- If finished: add dateEnded “M/D HH:MM”, elapsed M:SS, then “Finished”
- Ordering: preserves JSON array order (no sorting).
- Divider row of “=====” appears before any card after the first where sequence resets to 1; divider has no margins.
- Library Refresh control (added later): a “Library” button triggers Emby library refresh and polls scheduled-task progress every 2 seconds.

Networking / data flow summary
- Emby:
	- Emby credentials are managed in src/emby.js and urls are built via src/urls.js.
	- The client pulls show lists and episode children lists, and can build series maps.
- TVDB:
	- TVDB metadata is used for show maps and (for some shows) regular cast/characters.
- TMDB (via websocket server):
	- Episode guest cast is fetched via srvr.getTmdb({showName, season, episode}).
	- This call returned correct results at the working commit.

The requested “actors merge” feature (the goal for the next model)
The goal is to implement a deterministic merge of TMDB and TVDB actor lists on pane load, but ONLY where desired (currently: merge only on Regulars load; do NOT merge on Guests load).

Merge specification (verbatim intent)
On load of regular actors pane (and historically also guest pane, but currently only regulars), and before displaying any actors:
- Load actors from TMDB into a tmdb list.
- Load actors from TVDB into a tvdb list.
- Log size of each list.
- Create empty output list.
- Loop through these rules and log every action:
	----- beginning of loop -----
	- If tmdb list is empty append entire tvdb list to output and exit loop.
	- If tvdb list is empty append entire tmdb list to output and exit loop.
	- Compare first tmdb actor to first tvdb actor.
	- If duplicate names and one has image and other doesn't remove one that has no image from its list and move other to output.
	- If duplicate names and both have image remove tmdb from list and move tvdb to output.
	----- end of loop -----
- tmdb list should be empty.
- Use output list to display actors.
- Log output list size.
- New logging feature: count how many TVDB actors went to output and how many TMDB actors went to output and log counts at end.

Important note for implementing merge
- To make “compare first tmdb actor to first tvdb actor” work, both lists need to be sorted into the same ordering (likely by normalized actor name) before the loop.
- “Duplicate names” should compare normalized person names (case/whitespace-insensitive).
- “Has image” means a usable image URL is present for that actor.

Files to focus on for the merge work
- src/components/actors.vue (all merge logic and logging belongs here)
- src/srvr.js (client stub for srvr.getTmdb, but the endpoint already exists)
- Potentially src/components/App.vue (where tvdbData/show are emitted to Actors via evtBus)

How to reproduce
- Open the app, select a show, open Actors pane.
- In Guests mode, TMDB data should show for a selected Season/Episode (known-good at 1963a257...).
- In Regulars mode, TVDB characters should show if TVDB extended data is available.
- The merge feature should eventually combine both sources into a single displayed list in Regulars mode.

