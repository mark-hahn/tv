#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SSH_HOST="hahnca.com"

# Legacy flat remote layout (NOT a repo checkout).
# Example mapping:
#   local:  $ROOT_DIR/apps/api   -> remote: $TV_REMOTE_BASE/api
#   local:  $ROOT_DIR/apps/srvr  -> remote: $TV_REMOTE_BASE/srvr
#   local:  $ROOT_DIR/apps/down  -> remote: $TV_REMOTE_BASE/down
TV_REMOTE_BASE="${TV_REMOTE_BASE:-/root/dev/apps/tv}"

DEFAULT_TV_DATA_DIR="/root/dev/apps/tv-data"

if [[ ! -d "$ROOT_DIR/apps" ]]; then
  echo "Error: expected layout under $ROOT_DIR (missing apps/)" >&2
  exit 1
fi

usage() {
  echo "Usage: $(basename "$0") [api|down|srvr|client|share|all]" >&2
  echo "Env: TV_REMOTE_BASE (default: /root/dev/apps/tv on remote)" >&2
  echo "Env: TV_DATA_DIR (default: /root/dev/apps/tv-data on remote, used for pm2 env)" >&2
  exit 1
}

pm2_name_for_project() {
  case "$1" in
    api)  printf '%s' "tv-api" ;;
    down) printf '%s' "tv-down" ;;
    srvr) printf '%s' "tv-srvr" ;;
    client) printf '%s' "tv-client" ;;
    share) printf '%s' "tv-share" ;;
    *) return 1 ;;
  esac
}

remote_app_dir_for_project() {
  local project="$1"
  printf '%s/%s' "$TV_REMOTE_BASE" "$project"
}

local_app_dir_for_project() {
  local project="$1"
  case "$project" in
    share) printf '%s/packages/share' "$ROOT_DIR" ;;
    *) printf '%s/apps/%s' "$ROOT_DIR" "$project" ;;
  esac
}

remote_sync_app() {
  local project="$1"
  local local_dir
  local remote_dir
  local_dir="$(local_app_dir_for_project "$project")"
  remote_dir="$(remote_app_dir_for_project "$project")"

  if [[ ! -d "$local_dir" ]]; then
    echo "Error: missing local app dir: $local_dir" >&2
    exit 1
  fi

  echo "[remote] rsync apps/$project -> $SSH_HOST:$remote_dir"
  ssh "$SSH_HOST" "mkdir -p '$remote_dir'"

  # Note: --delete will only delete files under the target app dir.
  rsync -az --delete \
    --exclude 'node_modules/' \
    --exclude '.turbo/' \
    --exclude 'dist/' \
    --exclude 'build/' \
    --exclude '.output/' \
    --exclude '.cache/' \
    --exclude '.vite/' \
    --exclude '.nuxt/' \
    --exclude '.next/' \
    --exclude '.svelte-kit/' \
    --exclude '.parcel-cache/' \
    "$local_dir/" "$SSH_HOST:$remote_dir/"
}

remote_install_app_deps() {
  local project="$1"
  local remote_dir
  remote_dir="$(remote_app_dir_for_project "$project")"

  echo "[remote] deps: $remote_dir"
  # tv-down depends on better-sqlite3 which needs native build scripts.
  # pnpm on the server may have build scripts gated/disabled; use npm for this app.
  if [[ "$project" == "down" ]]; then
    ssh "$SSH_HOST" "cd '$remote_dir' \
      && if command -v npm >/dev/null 2>&1; then rm -rf node_modules && npm install; \
         elif command -v pnpm >/dev/null 2>&1; then pnpm install && pnpm rebuild better-sqlite3; \
         else echo 'Neither npm nor pnpm found on remote PATH' >&2; exit 1; fi"
  else
    ssh "$SSH_HOST" "cd '$remote_dir' \
      && if command -v pnpm >/dev/null 2>&1; then pnpm install; \
         elif command -v npm >/dev/null 2>&1; then npm install; \
         else echo 'Neither pnpm nor npm found on remote PATH' >&2; exit 1; fi"
  fi
}

remote_prepare_runtime_state() {
  # A fresh deploy checkout may not include runtime state files.
  # tv-srvr requires this file at startup.
  local project="${1:-all}"
  if [[ "$project" == "all" || "$project" == "srvr" ]]; then
    local tv_data_dir="${TV_DATA_DIR:-$DEFAULT_TV_DATA_DIR}"
    local srvr_data_dir="$tv_data_dir/srvr/data"
    echo "[remote] ensure tv-srvr state exists under $srvr_data_dir"
    ssh "$SSH_HOST" "mkdir -p '$srvr_data_dir' \
      && [ -f '$srvr_data_dir/lastViewed.json' ] || printf '{}' > '$srvr_data_dir/lastViewed.json' \
      && [ -f '$srvr_data_dir/notes.json' ]      || printf '{}' > '$srvr_data_dir/notes.json' \
      && [ -f '$srvr_data_dir/tvdb.json' ]       || printf '{}' > '$srvr_data_dir/tvdb.json' \
      && [ -f '$srvr_data_dir/noemby.json' ]     || printf '[]' > '$srvr_data_dir/noemby.json' \
      && [ -f '$srvr_data_dir/gaps.json' ]       || printf '[]' > '$srvr_data_dir/gaps.json'"
  fi
}

remote_pm2_restart_one() {
  local project="$1"
  local pm2_name
  local remote_dir
  pm2_name="$(pm2_name_for_project "$project")"
  remote_dir="$(remote_app_dir_for_project "$project")"

  local script
  case "$project" in
    api) script='src/server.js' ;;
    down) script='src/main.js' ;;
    srvr) script='index.js' ;;
    client)
      # Client is typically built and served by nginx; no pm2 process here by default.
      echo "[pm2] client: no pm2 process (deploy-only)"
      return 0
      ;;
    share)
      # Shared local package for legacy deploy mode; no pm2 process.
      echo "[pm2] share: no pm2 process (deploy-only)"
      return 0
      ;;
    *)
      echo "Error: unknown project: $project" >&2
      exit 1
      ;;
  esac

  local tv_data_dir="${TV_DATA_DIR:-$DEFAULT_TV_DATA_DIR}"
  echo "[pm2] restart $pm2_name (cwd=$remote_dir)"
  ssh "$SSH_HOST" "cd '$remote_dir' \
    && pm2 delete '$pm2_name' >/dev/null 2>&1 || true \
    && NODE_ENV=production TV_DATA_DIR='$tv_data_dir' DISABLE_INTERNAL_CORS=1 pm2 start '$script' --name '$pm2_name' --time \
    && pm2 save >/dev/null 2>&1 || true"
}

remote_deploy_one() {
  local project="$1"
  remote_sync_app "$project"
  remote_install_app_deps "$project"
  remote_prepare_runtime_state "$project"
  remote_pm2_restart_one "$project"
}

case "${1:-all}" in
  api|down|srvr|client|share)
    remote_deploy_one "$1"
    ;;
  all|"" )
    remote_deploy_one api
    remote_deploy_one srvr
    # Legacy flat deploy mode: down depends on @tv/share (file:../share).
    remote_deploy_one share
    # apps/down may fail to install in legacy flat deploy mode due to workspace deps.
    # Deploy it last, and don't block srvr/api deploys if it fails.
    if ! remote_deploy_one down; then
      echo "[warn] down deploy failed; api/srvr already deployed" >&2
    fi
    ;;
  *)
    usage
    ;;
esac
